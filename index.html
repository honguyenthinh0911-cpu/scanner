<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Galaxy Scanner — Quét Barcode/QR & Gửi n8n</title>
  <style>
    body{font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; margin:0; background:#0b1020; color:#eaf2ff}
    header{position:sticky; top:0; background:#0b1020cc; backdrop-filter: blur(6px); border-bottom:1px solid #223; padding:12px 16px}
    main{padding:16px; max-width:900px; margin:0 auto}
    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
    input, button, select{background:#111933; color:#eaf2ff; border:1px solid #2a3658; border-radius:12px; padding:10px 12px; font-size:16px}
    button{cursor:pointer}
    button.primary{background:#3a66ff; border-color:#3a66ff}
    .card{background:#0e1631; border:1px solid #1f2b4b; border-radius:16px; padding:14px}
    .grid{display:grid; gap:12px}
    .grid.cols-2{grid-template-columns: 1fr 1fr}
    #reader{border-radius:16px; overflow:hidden; border:1px solid #1f2b4b}
    table{width:100%; border-collapse: collapse;}
    th, td{border-bottom:1px solid #1f2b4b; padding:8px;}
  </style>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>
<body>
  <header class="row" style="justify-content:space-between">
    <div>
      <strong>Galaxy Scanner</strong>
      <div>Quét mã, cộng số lượng, gửi về n8n</div>
    </div>
    <div class="row">
      <label for="scanMode">Khung quét:</label>
      <select id="scanMode">
        <option value="qr">QR vuông (300x300)</option>
        <option value="barcode">Barcode ngang (400x150)</option>
      </select>
      <button class="primary" id="btn-restart">Áp dụng</button>
    </div>
  </header>

  <main class="grid cols-2">
    <div class="card">
      <div id="reader"></div>
      <div style="margin-top:8px">
        <label for="manual">Nhập tay:</label>
        <input id="manual" placeholder="Nhập barcode/QR rồi Enter hoặc bấm Thêm" />
        <button id="btn-add">Thêm</button>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="btn-undo">Hoàn tác</button>
        <button id="btn-clear">Xóa tất cả</button>
        <button id="btn-export">Xuất CSV</button>
      </div>
    </div>
    <div class="card">
      <div><strong>Danh sách quét</strong></div>
      <table>
        <thead><tr><th>Mã</th><th>Số lượng</th></tr></thead>
        <tbody id="tbody"></tbody>
      </table>
      <div style="margin-top:12px">
        <button class="primary" id="btn-send">Gửi về n8n</button>
      </div>
    </div>
  </main>

  <script>
    const state = {
      totals: new Map(),
      totalScans: 0,
      lastCode: null,
      sessionId: `sess_${Date.now()}`,
    };

    function playBeep(){
      const audio = new Audio('https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg');
      audio.play();
      if(navigator.vibrate) navigator.vibrate(50);
    }

    function addCode(raw){
      const code = String(raw||'').trim();
      if(!code) return;
      const prev = state.totals.get(code) || 0;
      state.totals.set(code, prev + 1);
      state.totalScans += 1;
      state.lastCode = code;
      playBeep();
      renderTable();
    }

    function undo(){
      const code = state.lastCode;
      if(!code) return;
      const current = state.totals.get(code) || 0;
      if(current <= 1) state.totals.delete(code);
      else state.totals.set(code, current - 1);
      state.totalScans = Math.max(0, state.totalScans - 1);
      state.lastCode = null;
      renderTable();
    }

    function clearAll(){
      state.totals.clear();
      state.totalScans = 0;
      state.lastCode = null;
      renderTable();
    }

    function toArrayTotals(){
      return Array.from(state.totals.entries()).map(([code,count])=>({code,count}));
    }

    function renderTable(){
      const tbody = document.getElementById('tbody');
      tbody.innerHTML = '';
      for(const [code,count] of state.totals.entries()){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${code}</td><td>${count}</td>`;
        tbody.appendChild(tr);
      }
    }

    async function sendToN8n(){
      const url = "https://galaxyfurchatbot.online/webhook-test/scanner";
      const payload = {
        session_id: state.sessionId,
        sent_at: new Date().toISOString(),
        total_scans: state.totalScans,
        totals: toArrayTotals()
      };
      try{
        await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        alert('Đã gửi dữ liệu về n8n!');
      }catch(e){ alert('Gửi thất bại: ' + e.message); }
    }

    function exportCSV(){
      const rows = [['code','count'], ...toArrayTotals().map(x=>[x.code,x.count])];
      const csv = rows.map(r=>r.join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `scanner_${Date.now()}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    function onScanSuccess(decodedText){ addCode(decodedText); }

    function startScanner(){
      const mode = document.getElementById('scanMode').value;
      let config;
      if(mode === 'qr') config = { fps: 10, qrbox: {width:300,height:300} };
      else config = { fps: 10, qrbox: {width:400,height:150} };
      if(window.scanner){ window.scanner.clear().catch(()=>{}); }
      window.scanner = new Html5QrcodeScanner('reader', config, false);
      window.scanner.render(onScanSuccess);
    }

    document.getElementById('btn-restart').onclick = startScanner;
    document.getElementById('btn-send').onclick = sendToN8n;
    document.getElementById('btn-export').onclick = exportCSV;
    document.getElementById('btn-clear').onclick = clearAll;
    document.getElementById('btn-undo').onclick = undo;
    document.getElementById('btn-add').onclick = ()=>{const v=document.getElementById('manual').value; addCode(v); document.getElementById('manual').value='';};
    document.getElementById('manual').addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault();document.getElementById('btn-add').click();}});

    startScanner();
  </script>
</body>
</html>
