<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Galaxy Scanner ‚Äî Qu√©t Barcode (Code128) & G·ª≠i n8n</title>
  <style>
    body{font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; margin:0; background:#0b1020; color:#eaf2ff}
    header{position:sticky; top:0; background:#0b1020cc; backdrop-filter: blur(6px); border-bottom:1px solid #223; padding:12px 16px}
    main{padding:16px; max-width:1100px; margin:0 auto}
    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
    label{font-size:14px; opacity:.9}
    input, button{background:#111933; color:#eaf2ff; border:1px solid #2a3658; border-radius:12px; padding:10px 12px; font-size:16px}
    button{cursor:pointer}
    button.primary{background:#3a66ff; border-color:#3a66ff}
    button.ghost{background:transparent}
    .card{background:#0e1631; border:1px solid #1f2b4b; border-radius:16px; padding:14px}
    .grid{display:grid; gap:16px}
    .muted{opacity:.8; font-size:14px}
    table{width:100%; border-collapse: collapse;}
    th, td{border-bottom:1px solid #1f2b4b; padding:10px; text-align:left}
    .kpi{display:flex; gap:12px; flex-wrap:wrap}
    .kpi div{background:#0e1631; padding:10px 12px; border:1px solid #1f2b4b; border-radius:12px}
    #reader{border-radius:16px; overflow:hidden; border:1px solid #1f2b4b; min-height:380px}
  </style>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>
<body>
  <header class="row" style="justify-content:space-between">
    <div>
      <strong>Galaxy Scanner</strong>
      <div class="muted">Qu√©t Code128, xem tr∆∞·ªõc danh s√°ch t·∫°m ‚Üí nh·∫≠p PO ‚Üí Nh·∫≠n PO</div>
    </div>
    <div class="kpi">
      <div>T·ªïng b·∫£n ghi: <strong id="kpi-unique">0</strong></div>
      <div>T·ªïng l∆∞·ª£t qu√©t: <strong id="kpi-count">0</strong></div>
    </div>
    <div class="row">
      <label for="webhook">Webhook n8n (POST)</label>
      <input id="webhook" type="url" value="https://galaxyfurchatbot.online/webhook-test/scanner" style="min-width:320px" />
      <button class="ghost" id="btn-save-webhook">üíæ L∆∞u Webhook</button>
      <button class="primary" id="btn-send">G·ª≠i v·ªÅ n8n</button>
      <button class="ghost" id="btn-export">Xu·∫•t CSV</button>
      <button class="err ghost" id="btn-clear">X√≥a t·∫•t c·∫£</button>
      <button class="ghost" onclick="initBeep()">üîä B·∫≠t √¢m thanh</button>
    </div>
  </header>

  <main class="grid">
    <section class="card">
      <div id="reader"></div>
      <div class="row" style="margin-top:12px">
        <input id="input-po" placeholder="Nh·∫≠p PO cho ƒë·ª£t qu√©t" style="flex:1" />
        <button class="primary" id="btn-commit">Nh·∫≠n PO</button>
      </div>
      <div class="muted" style="margin-top:8px">Danh s√°ch t·∫°m s·∫Ω hi·ªÉn th·ªã barcode v·ª´a qu√©t. Sau khi nh·∫≠p PO v√† Nh·∫≠n PO, d·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c g√°n v√† chuy·ªÉn v√†o danh s√°ch ch√≠nh.</div>
    </section>

    <section class="card">
      <h3>Danh s√°ch qu√©t t·∫°m (ch∆∞a g√°n PO)</h3>
      <div style="max-height:200px; overflow:auto; margin-bottom:12px">
        <table>
          <thead><tr><th>Barcode</th><th>S·ªë l∆∞·ª£ng</th><th>X√≥a</th></tr></thead>
          <tbody id="tbody-buffer"></tbody>
        </table>
      </div>
      <div class="row">
        <input id="manual-code" placeholder="Nh·∫≠p barcode tay" style="flex:1" />
        <input id="manual-count" type="number" min="1" value="1" style="width:80px" />
        <button id="btn-add-manual" class="ghost">Th√™m tay</button>
      </div>
    </section>

    <section class="card">
      <h3>Danh s√°ch barcode ƒë√£ g√°n PO</h3>
      <div style="max-height:300px; overflow:auto; margin-bottom:12px">
        <table>
          <thead><tr><th>M√£</th><th>PO</th><th>S·ªë l∆∞·ª£ng</th></tr></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    let beepSound;
    function initBeep(){
      beepSound = new Audio('beep.mp3');
      beepSound.load();
      alert('√Çm thanh ƒë√£ s·∫µn s√†ng, h√£y th·ª≠ qu√©t!');
    }

    function playBeep(){
      if(beepSound){
        beepSound.currentTime = 0;
        beepSound.play().catch(()=>{});
      }
      if(navigator.vibrate) navigator.vibrate(80);
    }

    const state = {
      totals: new Map(), // key = barcode|PO, value = count
      buffer: new Map(), // barcode ch∆∞a g√°n PO
      totalScans: 0,
      sessionId: `sess_${Date.now()}`,
      lastScanTime: 0,
      lastCode: null
    };

    function refreshKPIs(){
      document.getElementById('kpi-unique').textContent = state.totals.size;
      document.getElementById('kpi-count').textContent = state.totalScans;
    }

    function addToBuffer(barcode, qty=1){
      const now = Date.now();
      if(!barcode) return;

      // gi·∫£m delay xu·ªëng 1 gi√¢y
      if(barcode === state.lastCode && (now - state.lastScanTime < 1000)) {
        return;
      }

      state.lastScanTime = now;
      state.lastCode = barcode;

      const code128Regex = /^[A-Za-z0-9\-]+$/;
      if(!code128Regex.test(barcode)) return;

      const prev = state.buffer.get(barcode) || 0;
      state.buffer.set(barcode, prev + qty);
      renderBuffer();
      playBeep();
    }

    function removeFromBuffer(barcode){
      state.buffer.delete(barcode);
      renderBuffer();
    }

    function commitPO(){
      const po = document.getElementById('input-po').value.trim();
      if(!po){ alert('B·∫°n ch∆∞a nh·∫≠p PO'); return; }
      for(const [barcode, count] of state.buffer.entries()){
        const key = `${barcode}|${po}`;
        const prev = state.totals.get(key) || 0;
        state.totals.set(key, prev + count);
        state.totalScans += count;
      }
      state.buffer.clear();
      document.getElementById('input-po').value = '';
      renderBuffer();
      renderTable();
      refreshKPIs();
      restartScanner();
    }

    function clearAll(){
      state.totals.clear(); state.buffer.clear(); state.totalScans = 0;
      renderBuffer(); renderTable(); refreshKPIs();
    }

    function toArrayTotals(){
      return Array.from(state.totals.entries()).map(([key,count])=>{
        const [barcode, po] = key.split('|');
        return {code: barcode, po: po, count: count};
      });
    }

    function renderBuffer(){
      const tbody = document.getElementById('tbody-buffer');
      tbody.innerHTML = '';
      for (const [barcode, count] of state.buffer.entries()){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${barcode}</td><td>${count}</td><td><button onclick=\"removeFromBuffer('${barcode}')\">‚ùå</button></td>`;
        tbody.appendChild(tr);
      }
    }

    function renderTable(){
      const tbody = document.getElementById('tbody');
      tbody.innerHTML = '';
      for (const [key, count] of state.totals.entries()){
        const [barcode, po] = key.split('|');
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${barcode}</td><td>${po}</td><td>${count}</td>`;
        tbody.appendChild(tr);
      }
    }

    async function sendToN8n(){
      const url = document.getElementById('webhook').value.trim();
      if(!url){ alert('B·∫°n ch∆∞a ƒëi·ªÅn URL webhook n8n'); return; }
      const payload = {
        device: navigator.userAgent,
        session_id: state.sessionId,
        sent_at: new Date().toISOString(),
        total_scans: state.totalScans,
        totals: toArrayTotals(),
      };
      try{
        await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        alert('ƒê√£ g·ª≠i d·ªØ li·ªáu v·ªÅ n8n!');
      }catch(err){
        console.error(err);
        alert('G·ª≠i th·∫•t b·∫°i. Ki·ªÉm tra URL webhook & CORS.');
      }
    }

    function exportCSV(){
      const rows = [['code','po','count'], ...toArrayTotals().map(x=>[x.code, x.po, x.count])];
      const csv = rows.map(r => r.map(v => '"'+String(v).replace(/"/g,'""')+'"').join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `scanner_totals_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.csv`;
      document.body.appendChild(a); a.click(); a.remove();
    }

    function onScanSuccess(decodedText){
      addToBuffer(String(decodedText||'').trim());
    }

    function startScanner(){
      const config = { 
        fps: 30, // tƒÉng t·ªëc ƒë·ªô qu√©t
        qrbox: {width:700, height:250}, // v√πng qu√©t l·ªõn h∆°n ƒë·ªÉ h·ªó tr·ª£ barcode nh·ªè/nh√≤e
        rememberLastUsedCamera:true,
        showTorchButtonIfSupported:true,
        aspectRatio:1.7778,
        experimentalFeatures: { useBarCodeDetectorIfSupported: true },
        videoConstraints: {
          facingMode: "environment",
          width: { ideal: 1920 },
          height: { ideal: 1080 }
        }
      };
      if(window.scanner){ window.scanner.clear().catch(()=>{}); }
      window.scanner = new Html5QrcodeScanner('reader', config, false);
      window.scanner.render(onScanSuccess);
    }

    function restartScanner(){
      if(window.scanner){
        window.scanner.clear().then(()=>{
          startScanner();
        }).catch(()=>{
          startScanner();
        });
      } else {
        startScanner();
      }
    }

    // L∆∞u webhook v√†o localStorage
    const webhookInput = document.getElementById('webhook');
    const savedWebhook = localStorage.getItem('scannerWebhook');
    if(savedWebhook) webhookInput.value = savedWebhook;
    document.getElementById('btn-save-webhook').onclick = ()=>{
      localStorage.setItem('scannerWebhook', webhookInput.value.trim());
      alert('Webhook ƒë√£ l∆∞u!');
    };

    document.getElementById('btn-send').onclick = sendToN8n;
    document.getElementById('btn-export').onclick = exportCSV;
    document.getElementById('btn-clear').onclick = clearAll;
    document.getElementById('btn-commit').onclick = commitPO;
    document.getElementById('btn-add-manual').onclick = ()=>{
      const code = document.getElementById('manual-code').value.trim();
      const qty = parseInt(document.getElementById('manual-count').value)||1;
      if(code){ addToBuffer(code, qty); }
      document.getElementById('manual-code').value='';
      document.getElementById('manual-count').value=1;
    };

    startScanner();
  </script>
</body>
</html>